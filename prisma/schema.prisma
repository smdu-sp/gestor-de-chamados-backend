generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Modelos de Autenticação e Usuários
// ==========================================

model Usuario {
  id           String    @id @default(uuid())
  nome         String
  login        String    @unique
  email        String    @unique
  status       Boolean   @default(true)
  avatar       String?   @db.Text
  ultimoLogin  DateTime?
  criadoEm     DateTime  @default(now())
  atualizadoEm DateTime  @updatedAt
  permissao    Permissao @default(USR)

  // Relações
  chamadosAbertos   Chamado[]        @relation("CriadorDoChamado")
  chamadosAtendidos TecnicoChamado[]
  acompanhamentos   Acompanhamento[]
  logs              LogSistema[]

  @@map("usuarios")
}

enum Permissao {
  ADM // Administrador
  SUP // Técnico de Suporte (Help Desk)
  INF // Técnico de Infraestrutura
  VOIP // Técnico de Telefonia
  CAD // Cadastro de usuários
  USR // Usuário comum (pode apenas abrir chamados)
  IMP // Técnico de Impressoras
  DEV // Desenvolvedor
}

// ==========================================
// Modelos do Sistema de Chamados
// ==========================================

model Chamado {
  id            String    @id @default(uuid())  
  titulo        String
  descricao     String        @db.Text
  status        StatusChamado @default(NOVO)
  criadoEm      DateTime      @default(now())
  atualizadoEm  DateTime      @updatedAt
  solucionadoEm DateTime?
  fechadoEm     DateTime?

  categoriaId String
  categoria   Categoria @relation(fields: [categoriaId], references: [id])

  subcategoriaId String
  subcategoria   Subcategoria @relation(fields: [subcategoriaId], references: [id])

  criadorId String
  criador   Usuario @relation("CriadorDoChamado", fields: [criadorId], references: [id])

  tecnicos        TecnicoChamado[]
  acompanhamentos Acompanhamento[]

  @@map("chamados")
}

model Acompanhamento {
  id       String    @id @default(uuid())
  conteudo String   @db.Text
  criadoEm DateTime @default(now())

  chamadoId String
  chamado   Chamado @relation(fields: [chamadoId], references: [id], onDelete: Cascade)

  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  @@map("acompanhamentos")
}

model TecnicoChamado {
  chamadoId String
  chamado   Chamado @relation(fields: [chamadoId], references: [id], onDelete: Cascade)

  tecnicoId String
  tecnico   Usuario @relation(fields: [tecnicoId], references: [id])

  atribuidoEm DateTime @default(now())

  @@id([chamadoId, tecnicoId])
  @@map("tecnicos_chamados")
}

// ==========================================
// Modelos de Categorização de Chamados
// ==========================================

model Categoria {
  id                 String    @id @default(uuid())
  nome               String               @unique // Ex: "Hardware", "Software", "Rede"
  status             Boolean              @default(true)
  permissoesVisiveis CategoriaPermissao[]
  criadoEm      DateTime      @default(now())
  atualizadoEm  DateTime      @updatedAt

  subcategorias Subcategoria[]
  chamados      Chamado[]

  @@map("categorias")
}

model Subcategoria {
  id   String    @id @default(uuid())
  nome String // Ex: "Mouse quebrado", "Instalar Office", "Ponto de rede"

  categoriaId String
  categoria   Categoria @relation(fields: [categoriaId], references: [id])
  chamados    Chamado[]

  @@unique([categoriaId, nome])
  @@map("subcategorias")
}

model CategoriaPermissao {
  categoriaId String
  categoria   Categoria @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  permissao   Permissao

  @@id([categoriaId, permissao])
  @@map("categoria_permissoes")
}

enum StatusChamado {
  NOVO
  ATRIBUIDO
  RESOLVIDO
  REJEITADO
  FECHADO
}

// ==========================================
// Modelos de Auditoria do Sistema
// ==========================================

model LogSistema {
  id   String    @id @default(uuid())
  usuarioId  String
  usuario    Usuario  @relation(fields: [usuarioId], references: [id])
  acao       String
  entidade   String
  entidadeId String
  detalhes   String?  @db.Text
  criadoEm   DateTime @default(now())

  @@map("logs_sistema")
}